<div class="min-vh-100 bg-light py-4">
  @if (!isLoading && complaint) {
    <div class="container">
      <button class="btn btn-outline-secondary mb-4" (click)="goBack()">
        ← Back to Complaints
      </button>

      <div class="row g-4">
        <div class="col-lg-8">
          <div class="card shadow mb-4">
            <div class="card-body p-4">
              <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                  <span class="badge bg-secondary mb-2">{{ complaint.complaint_number }}</span>
                  <h1 class="h3">{{ complaint.subject }}</h1>
                </div>
                <span [class]="'badge fs-6 ' + getStatusClass(complaint.status)">
                  {{ complaint.status }}
                </span>
              </div>

              <div class="card bg-light mb-4">
                <div class="card-body">
                  <h3 class="h6 mb-3">Submitted By</h3>
                  @if (complaint.is_anonymous) {
                    <p class="mb-0">
                      <span class="badge bg-secondary">Anonymous Complaint</span>
                    </p>
                    <p class="text-muted small mt-2 mb-0">User identity is hidden for this complaint</p>
                  } @else {
                    <p class="mb-1"><strong>Name:</strong> {{ complaint.user?.full_name }}</p>
                    <p class="mb-1"><strong>Email:</strong> {{ complaint.user?.email }}</p>
                    @if (complaint.user?.department) {
                      <p class="mb-0"><strong>Department:</strong> {{ complaint.user?.department }}</p>
                    }
                  }
                </div>
              </div>

              <div class="row g-3 mb-4">
                <div class="col-md-6">
                  <small class="text-muted d-block">Category:</small>
                  <strong>{{ complaint.category?.category_name }}</strong>
                </div>
                <div class="col-md-6">
                  <small class="text-muted d-block">Priority:</small>
                  <strong [class.text-danger]="complaint.priority === 'High'"
                          [class.text-warning]="complaint.priority === 'Medium'"
                          [class.text-success]="complaint.priority === 'Low'">
                    {{ complaint.priority }}
                  </strong>
                </div>
                <div class="col-md-6">
                  <small class="text-muted d-block">Submitted:</small>
                  <strong>{{ complaint.created_at | date:'medium' }}</strong>
                </div>
                @if (complaint.assignedAdmin) {
                  <div class="col-md-6">
                    <small class="text-muted d-block">Assigned To:</small>
                    <strong>{{ complaint.assignedAdmin.full_name }} ({{ complaint.assignedAdmin.role }})</strong>
                  </div>
                }
              </div>

              <div class="mb-4">
                <h3 class="h5 mb-2">Description</h3>
                <p class="mb-0">{{ complaint.description }}</p>
              </div>

              @if (complaint.updates && complaint.updates.length > 0) {
                <div>
                  <h3 class="h5 mb-3">Update History</h3>
                  <div class="list-group">
                    @for (update of complaint.updates; track $index) {
                      <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                          <strong class="text-primary">{{ update.admin?.full_name }}</strong>
                          <small class="text-muted">{{ update.created_at | date:'short' }}</small>
                        </div>
                        <div class="mb-2">
                          Status changed: <strong>{{ update.previous_status }}</strong> → <strong>{{ update.new_status }}</strong>
                        </div>
                        @if (update.comments) {
                          <div class="mb-2">
                            <strong>Comments:</strong> {{ update.comments }}
                          </div>
                        }
                        @if (update.resolution_details) {
                          <div class="alert alert-success mb-0 mt-2">
                            <strong>Resolution:</strong> {{ update.resolution_details }}
                          </div>
                        }
                      </div>
                    }
                  </div>
                </div>
              }

              <div class="mt-4">
                <app-complaint-chat [complaintId]="complaint.id"></app-complaint-chat>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card shadow">
            <div class="card-body p-4">
              <h2 class="h5 mb-4">Manage Complaint</h2>

              @if (errorMessage) {
                <div class="alert alert-danger" role="alert">
                  {{ errorMessage }}
                </div>
              }

              @if (successMessage) {
                <div class="alert alert-success" role="alert">
                  {{ successMessage }}
                </div>
              }

              <form (ngSubmit)="updateStatus()">
                <div class="mb-3">
                  <label for="status" class="form-label">Update Status</label>
                  <select
                    id="status"
                    name="status"
                    [(ngModel)]="updateForm.status"
                    [disabled]="isUpdating"
                    required
                    class="form-select"
                  >
                    <option value="Pending">Pending</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Resolved">Resolved</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label for="comments" class="form-label">Comments</label>
                  <textarea
                    id="comments"
                    name="comments"
                    [(ngModel)]="updateForm.comments"
                    placeholder="Add comments about this complaint..."
                    [disabled]="isUpdating"
                    rows="4"
                    class="form-control"
                  ></textarea>
                </div>

                <div class="mb-3">
                  <label for="resolution" class="form-label">Resolution Details</label>
                  <textarea
                    id="resolution"
                    name="resolution"
                    [(ngModel)]="updateForm.resolution_details"
                    placeholder="Provide resolution details (required when marking as resolved)..."
                    [disabled]="isUpdating"
                    rows="4"
                    class="form-control"
                  ></textarea>
                </div>

                <button
                  type="submit"
                  class="btn btn-primary w-100"
                  [disabled]="isUpdating"
                >
                  @if (!isUpdating) {
                    <span>Update Complaint</span>
                  }
                  @if (isUpdating) {
                    <span>Updating...</span>
                  }
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  }

  @if (isLoading) {
    <div class="container text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 text-muted">Loading complaint details...</p>
    </div>
  }

  @if (errorMessage && !complaint) {
    <div class="container">
      <div class="alert alert-danger" role="alert">
        {{ errorMessage }}
      </div>
    </div>
  }
</div>
