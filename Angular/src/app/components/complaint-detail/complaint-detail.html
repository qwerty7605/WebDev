<div class="min-vh-100 bg-light py-4">
  @if (!isLoading && complaint) {
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <button class="btn btn-outline-secondary" (click)="goBack()">
          ← Back to Complaints
        </button>
        @if (complaint.status === 'Pending') {
          <button class="btn btn-danger" (click)="deleteComplaint()">
            Delete Complaint
          </button>
        }
      </div>

      <div class="card shadow">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-start mb-4">
            <div>
              <span class="badge bg-secondary mb-2">{{ complaint.complaint_number }}</span>
              <h1 class="h3">{{ complaint.subject }}</h1>
            </div>
            <span [class]="'badge fs-6 ' + getStatusClass(complaint.status)">
              {{ complaint.status }}
            </span>
          </div>

          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <small class="text-muted d-block">Category:</small>
              <strong>{{ complaint.category?.category_name }}</strong>
            </div>
            <div class="col-md-6">
              <small class="text-muted d-block">Submitted:</small>
              <strong>{{ complaint.created_at | date:'medium' }}</strong>
            </div>
            @if (complaint.assignedAdmin) {
              <div class="col-md-6">
                <small class="text-muted d-block">Assigned To:</small>
                <strong>{{ complaint.assignedAdmin.full_name }} ({{ complaint.assignedAdmin.role }})</strong>
              </div>
            }
            @if (complaint.is_anonymous) {
              <div class="col-md-6">
                <small class="text-muted d-block">Submission Type:</small>
                <span class="badge bg-secondary">Anonymous</span>
              </div>
            }
          </div>

          <div class="mb-4">
            <h3 class="h5 mb-2">Description</h3>
            <p class="mb-0">{{ complaint.description }}</p>
          </div>

          @if (complaint.attachment) {
            <div class="mb-4">
              <h3 class="h5 mb-2">Evidence/Attachment</h3>
              <div class="card">
                @if (isImage()) {
                  <img
                    [src]="getAttachmentUrl()"
                    [alt]="complaint.attachment.file_name"
                    class="card-img-top"
                    style="max-height: 500px; object-fit: contain; background-color: #f8f9fa;"
                    (error)="$event.target.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5JbWFnZSBub3QgYXZhaWxhYmxlPC90ZXh0Pjwvc3ZnPg=='"
                  />
                }
                @if (isVideo()) {
                  <video
                    [src]="getAttachmentUrl()"
                    controls
                    class="card-img-top"
                    style="max-height: 500px; background-color: #000;"
                  >
                    Your browser does not support the video tag.
                  </video>
                }
                <div class="card-body">
                  <p class="mb-2"><strong>File Name:</strong> {{ complaint.attachment.file_name }}</p>
                  <small class="text-muted d-block">File Type: {{ complaint.attachment.mime_type }}</small>
                  <small class="text-muted d-block">File Size: {{ (complaint.attachment.file_size / 1024 / 1024).toFixed(2) }} MB</small>
                  <small class="text-muted d-block">Storage Path: {{ complaint.attachment.file_path }}</small>
                  <a [href]="getAttachmentUrl()" target="_blank" class="btn btn-sm btn-primary mt-2">
                    @if (isImage()) {
                      <span>Open Image in New Tab</span>
                    }
                    @if (isVideo()) {
                      <span>Open Video in New Tab</span>
                    }
                  </a>
                </div>
              </div>
            </div>
          }

          @if (complaint.updates && complaint.updates.length > 0) {
            <div>
              <h3 class="h5 mb-3">Updates & Comments</h3>
              <div class="list-group">
                @for (update of complaint.updates; track $index) {
                  <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <strong class="text-primary">{{ update.admin?.full_name }}</strong>
                      <small class="text-muted">{{ update.created_at | date:'short' }}</small>
                    </div>
                    <div class="mb-2">
                      Status changed: <strong>{{ update.previous_status }}</strong> → <strong>{{ update.new_status }}</strong>
                    </div>
                    @if (update.comments) {
                      <div class="mb-2">
                        <strong>Comments:</strong> {{ update.comments }}
                      </div>
                    }
                    @if (update.resolution_details) {
                      <div class="alert alert-success mb-0 mt-2">
                        <strong>Resolution:</strong> {{ update.resolution_details }}
                      </div>
                    }
                  </div>
                }
              </div>
            </div>
          }

          @if (complaint.assigned_to) {
            <div class="mt-4">
              <app-complaint-chat [complaintId]="complaint.id"></app-complaint-chat>
            </div>
          }
        </div>
      </div>
    </div>
  }

  @if (isLoading) {
    <div class="container text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 text-muted">Loading complaint details...</p>
    </div>
  }

  @if (errorMessage) {
    <div class="container">
      <div class="alert alert-danger" role="alert">
        {{ errorMessage }}
      </div>
    </div>
  }
</div>
